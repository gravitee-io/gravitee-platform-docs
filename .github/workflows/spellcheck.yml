name: Spellcheck Documentation

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read  # Required for reading repository content
  pull-requests: write  # Required for creating comments on PRs

jobs:
  spellcheck:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: pip install codespell

      - name: Run Spellcheck and Save Report
        run: |
          set -e  # Exit on error

          # Run codespell and capture results
          codespell --ignore-words=.github/spellcheck-ignore.txt \
                    --skip=".git,*.lock,*.json,*.yaml,*.yml,*.css,*.html" \
                    --quiet-level=2 > spellcheck_report.txt || true

      - name: Print Spellcheck Report ðŸ“œ
        if: always()
        run: |
          echo "===== Spellcheck Report ====="
          if [ -s spellcheck_report.txt ]; then
            cat spellcheck_report.txt
          else
            echo "No spelling errors found."
          fi
          echo "============================"

      - name: Post Inline Suggestions
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_GITHUB_ACTIONS }}
        run: |
          if [ -s spellcheck_report.txt ]; then
            while IFS= read -r line; do
              file=$(echo "$line" | cut -d ':' -f 1)
              line_number=$(echo "$line" | cut -d ':' -f 2)
              original_word=$(echo "$line" | cut -d ' ' -f 2)
              corrected_word=$(echo "$line" | cut -d ' ' -f 4)

              if [ -f "$file" ]; then
                # Create a suggestion comment
                suggestion="Suggestion:\n\`\`\`suggestion\n$(sed "${line_number}q;d" "$file" | sed "s/\b${original_word}\b/${corrected_word}/g")\n\`\`\`"

                # Post the suggestion using GitHub's REST API
                curl -s -H "Authorization: token $GITHUB_TOKEN" \
                     -X POST \
                     -d "$(jq -n --arg body "$suggestion" --arg path "$file" --argjson line $line_number '{body: $body, path: $path, line: $line, side: "RIGHT"}')" \
                     "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments"
              fi
            done < spellcheck_report.txt
          else
            echo "No spelling errors found. No suggestions to post."
          fi
