name: Spellcheck Documentation

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  spellcheck:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Codespell
        run: pip install codespell

      - name: Prepare Case-Sensitive Ignore List
        run: |
          IGNORE_FILE=".github/spellcheck_ignore.txt"
          TEMP_IGNORE_FILE="spellcheck_temp_ignore.txt"

          if [ ! -f "$IGNORE_FILE" ]; then
            echo "Warning: $IGNORE_FILE not found. Creating an empty ignore file."
            touch "$IGNORE_FILE"
          fi

          # Add all terms from spellcheck_ignore.txt exactly as they appear
          cat "$IGNORE_FILE" > "$TEMP_IGNORE_FILE"

          # Convert all acronyms to lowercase for use in code blocks
          awk '{print tolower($0)}' "$IGNORE_FILE" >> "$TEMP_IGNORE_FILE"

          # Remove duplicates
          sort -u "$TEMP_IGNORE_FILE" -o "$TEMP_IGNORE_FILE"

      - name: Run Spellcheck
        run: |
          mkdir -p spellcheck-reports
          OUTPUT_FILE="spellcheck-reports/spellcheck-results.txt"

          # Run Codespell and capture flagged words + locations
          codespell --ignore-words="spellcheck_temp_ignore.txt" \
                    --skip="*.json,*.xml,*.html,*.css,*.yml,*.yaml,*.csv,*.ts,*.js,*.py" \
                    --quiet-level=2 \
                    --check-filenames \
                    --check-hidden \
                    --write-changes \
                    --exclude-file=".github/exclude-patterns.txt" \
                    2>&1 | tee "$OUTPUT_FILE"

      - name: Upload Spellcheck Report
        uses: actions/upload-artifact@v4
        with:
          name: spellcheck-results
          path: spellcheck-reports/spellcheck-results.txt
