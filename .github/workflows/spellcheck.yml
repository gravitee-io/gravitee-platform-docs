name: Spellcheck Documentation

on:
  pull_request:
    branches:
      - main

permissions:
  pull-requests: write  # Required to add comments and suggestions

jobs:
  spellcheck:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          pip install codespell

      - name: Run Spellcheck
        run: |
          codespell --ignore-words=.github/spellcheck-ignore.txt \
                    --skip=".git,*.lock,*.json,*.yaml,*.yml,*.css,*.html" \
                    --quiet-level=2 > spellcheck_report.txt || true

      - name: Post Suggestions as GitHub Review Comments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          while IFS= read -r line; do
            file=$(echo "$line" | cut -d ':' -f 1)
            line_number=$(echo "$line" | cut -d ':' -f 2)
            original_word=$(echo "$line" | awk '{print $3}')
            corrected_word=$(echo "$line" | awk '{print $5}')

            # Ensure all required variables exist
            if [[ -z "$file" || -z "$line_number" || -z "$original_word" || -z "$corrected_word" ]]; then
              continue
            fi

            # Use GitHub API to add suggestions
            curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
                 -H "Accept: application/vnd.github.v3+json" \
                 -d @- https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments <<EOF
            {
              "body": "Suggested change:\n\`\`\`suggestion\n$corrected_word\n\`\`\`",
              "commit_id": "${{ github.event.pull_request.head.sha }}",
              "path": "$file",
              "side": "RIGHT",
              "line": $line_number
            }
EOF

          done < spellcheck_report.txt || true
