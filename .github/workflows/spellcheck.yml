name: Spellcheck Documentation

on:
  push:
    branches:
      - main

permissions:
  contents: read  # Required for reading repository content
  pull-requests: write  # Required for creating comments on PRs

jobs:
  spellcheck:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: pip install codespell

      - name: Run Spellcheck and Save Report
        run: |
          set -e  # Exit on error

          # Run codespell and capture results
          codespell --ignore-words=.github/spellcheck-ignore.txt \
                    --skip=".git,*.lock,*.json,*.yaml,*.yml,*.css,*.html" \
                    --quiet-level=2 > spellcheck_report.txt || true

      - name: Print Spellcheck Report üìú
        if: always()
        run: |
          echo "===== Spellcheck Report ====="
          if [ -s spellcheck_report.txt ]; then
            cat spellcheck_report.txt
          else
            echo "No spelling errors found."
          fi
          echo "============================"

      - name: Post Inline Suggestions
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_GITHUB_ACTIONS }}
        run: |
          if [ -s spellcheck_report.txt ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
            REPO=${{ github.repository }}

            echo "Processing spellcheck suggestions..."
            while IFS= read -r line; do
              FILE=$(echo "$line" | cut -d ':' -f 1)
              LINE_NUMBER=$(echo "$line" | cut -d ':' -f 2)
              ORIGINAL_WORD=$(echo "$line" | cut -d ' ' -f 2)
              CORRECTED_WORD=$(echo "$line" | cut -d ' ' -f 4)

              if [ -f "$FILE" ]; then
                # Extract the original line from the file
                ORIGINAL_LINE=$(sed "${LINE_NUMBER}q;d" "$FILE")

                # Construct the GitHub suggestion
                SUGGESTION_BODY="#### Spelling Suggestion üìù\n\`\`\`suggestion\n$(echo "$ORIGINAL_LINE" | sed "s/\b${ORIGINAL_WORD}\b/${CORRECTED_WORD}/g")\n\`\`\`\n*Suggested change in \`$FILE\`, line $LINE_NUMBER*"

                # Post the suggestion to GitHub PR
                curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/comments \
                  -d @- <<EOF
{
  "body": "$SUGGESTION_BODY",
  "commit_id": "${{ github.event.pull_request.head.sha }}",
  "path": "$FILE",
  "line": $LINE_NUMBER,
  "side": "RIGHT"
}
EOF

              fi
            done < spellcheck_report.txt
          else
            echo "No spelling errors found."
          fi
