name: Spellcheck Documentation

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  spellcheck:
    name: Run Spellcheck
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Codespell
        run: pip install codespell

      - name: Run Spellcheck
        run: |
          set -e  # Exit on error

          SPELLCHECK_OUTPUT="spellcheck_report.txt"
          EXCLUDE_PATTERNS=".github/exclude-patterns.txt"
          IGNORE_LIST=".github/spellcheck-ignore.txt"

          # Clear previous spellcheck output
          > "$SPELLCHECK_OUTPUT"

          echo "Running Spellcheck..."

          # Run spellcheck and capture output
          codespell --ignore-words-list=$(tr '\n' ',' < "$IGNORE_LIST") --quiet-level=2 --skip=$(cat "$EXCLUDE_PATTERNS") > temp_spellcheck.log || true

          # Debugging: Show raw spellcheck output
          echo "=== RAW SPELLCHECK OUTPUT ==="
          cat temp_spellcheck.log || echo "No output found."
          echo "=== END OF RAW OUTPUT ==="

          echo "Processing spellcheck results..."

          # Ensure output file is only created if errors exist
          if [[ -s temp_spellcheck.log ]]; then
              while IFS= read -r line; do
                  FILE=$(echo "$line" | awk -F':' '{print $1}')
                  LINE_NUM=$(echo "$line" | awk -F':' '{print $2}')
                  ERROR_WORD=$(echo "$line" | awk -F':' '{print $3}')

                  if [[ -n "$FILE" && -n "$LINE_NUM" && -n "$ERROR_WORD" ]]; then
                      echo "$FILE" >> "$SPELLCHECK_OUTPUT"
                      echo "  Line $LINE_NUM: $ERROR_WORD" >> "$SPELLCHECK_OUTPUT"
                      echo "" >> "$SPELLCHECK_OUTPUT"
                  fi
              done < temp_spellcheck.log
              echo "Spellcheck report saved to $SPELLCHECK_OUTPUT"
          else
              echo "No spelling errors detected."
          fi

      - name: Debugging: Print Spellcheck Report
        if: always()
        run: cat spellcheck_report.txt || echo "No errors recorded in spellcheck_report.txt."

      - name: Upload Spellcheck Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spellcheck-report
          path: spellcheck_report.txt
